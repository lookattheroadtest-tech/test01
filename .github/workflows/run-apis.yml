name: API Runner

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Authorization header as-is
        run: |
          AUTH_LINE=$(cat auth_file)
          echo "AUTH_LINE=$AUTH_LINE" >> $GITHUB_ENV

      - name: Run API calls safely
        shell: bash
        run: |
          mkdir -p results

          API_FILE="api_requests"

          # Convert CRLF â†’ LF to prevent bash errors
          sed -i 's/\r$//' "$API_FILE"

          counter=1
          buffer=""

          while IFS= read -r line; do
            # Empty line = end of a curl block
            if [[ -z "$line" ]]; then
              if [[ -n "$buffer" ]]; then
                echo "Running request #$counter"
                echo "$buffer" | sed "s|curl|curl -H \"$AUTH_LINE\"|" > run.sh
                bash run.sh > "results/output_$counter.json" 2>&1
                buffer=""
                counter=$((counter+1))
              fi
            else
              buffer="$buffer"$'\n'"$line"
            fi
          done < "$API_FILE"

          # Run the final buffer if no blank line at end
          if [[ -n "$buffer" ]]; then
            echo "Running request #$counter"
            echo "$buffer" | sed "s|curl|curl -H \"$AUTH_LINE\"|" > run.sh
            bash run.sh > "results/output_$counter.json" 2>&1
          fi
          
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: api-results
          path: results/
